<html>
<head>
  <title>Web-Bluetooth test with the Nordic UART service</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  background-color: #ffffff;
  font-family: "Helvetica", "Arial", sans-serif;
}

pre {
  font-family: monospace;
}

.output {
  background-color: #f0f0f0;
  border-radius: 0.75em;
  display: block;
  margin: 0.5em;
  padding: 0.5em;
}

#log {
  margin: .5em 0;
  white-space: pre-wrap;
}

#log:empty {
  display: none;
}

</style>
</head>
<body>

<h1>Using the Nordic UART service with Web-Bluetooth</h1>
<form>
  <button id="connect">Connect</button>
  <button id="disconnect">Disconnect</button>
  <button id="send">Send 'Hello world'</button>
</form>

<h3>Log output</h3>
<div id="output" class="output">
  <pre id="log"></pre>
</div>

<script>

var ACCELEROMETER_SERVICE_UUID               = "e95d0753-251d-470a-a062-fa1922dfa9a8";
var ACCELEROMETER_DATA_CHARACTERISTIC_UUID   = "e95dca4b-251d-470a-a062-fa1922dfa9a8";
var ACCELEROMETER_PERIOD_CHARACTERISTIC_UUID = "e95dfb24-251d-470a-a062-fa1922dfa9a8";
  

  
  
var bluetoothDevice = null;
var dataCharacteristic = null;
var periodCharacteristic = null;

var Logger = {
  log: function(line) {
    document.querySelector('#log').textContent += line + '\n';
  },

  clearLog: function() {
    document.querySelector('#log').textContent = '';
  },
};
var log = Logger.log;


function onDisconnected(event) {
  log('Bluetooth Device disconnected');

  if (dataCharacteristic) {
    dataCharacteristic.removeEventListener('characteristicvaluechanged', handleNotifications);
  }

  dataCharacteristic = null;
  periodCharacteristic = null;
}

function onStartButtonClick() {
  let serviceUuid = ACCELEROMETER_SERVICE_UUID;
  let dataCharacteristicUuid = ACCELEROMETER_DATA_CHARACTERISTIC_UUID;
  let periodCharacteristicUuid = ACCELEROMETER_PERIOD_CHARACTERISTIC_UUID;

  log('Requesting Bluetooth Device...');
//   navigator.bluetooth.requestDevice({filters: [{services: [serviceUuid]}]})
  
  uBitDevice = navigator.bluetooth.requestDevice({
    filters: [{ namePrefix: "BBC micro:bit", services: [serviceUuid]}],
   })
  .then(device => {
    bluetoothDevice = device;
    bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

    log('Connecting to GATT Server...');
    return device.gatt.connect();
  })
  .then(server => {
    log('Getting Service...');
    return server.getPrimaryService(serviceUuid);
  })
  .then(service => {
    log('Getting Characteristics...');
    return Promise.all([
      service.getCharacteristic(dataCharacteristicUuid)
        .then(characteristic => {
          dataCharacteristic = characteristic;
          log('Data charactersitic obtained');
          return txCharacteristic.startNotifications().then(_ => {
            log('Notifications started');
            dataCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
          });
        }),

    ]);
  })
  .catch(error => {
    log('Argh! ' + error);
  });
}


function onStopButtonClick() {
  if (txCharacteristic) {
    log('Stopping notifications...');
    try {
      dataCharacteristic.removeEventListener('characteristicvaluechanged', handleNotifications);
    }
    catch(error) {
      log('Argh! ' + error);
    }
    dataCharacteristic = null;
    // txCharacteristic.stopNotifications()
    // .then(_ => {
    //   log('Notifications stopped');
    // })
    // .catch(error => {
    //   log('Argh! ' + error);
    // });
  }

  if (bluetoothDevice) {
    if (bluetoothDevice.gatt.connected) {
      log('Disconnecting from Bluetooth Device...');
      bluetoothDevice.gatt.disconnect();
    }
  }
}

function onSendButtonClick() {
  if (rxCharacteristic) {
    log('Sending string via RX characteristic...');

    var repeat = function (count) {
      if (count > 0) {
        rxCharacteristic.writeValue(str2ab("Hello world " + count + " abcdefghijklmnopqrstuvwxyz\n"))
        .then(_ => {
          repeat(count - 1);
        })
        .catch(error => {
          log('Argh! ' + error);
        });
      }
    }

    repeat(50);
  }
}


function handleNotifications(event) {
  let value = event.target.value;

  result = ''
  for (let i = 0; i < value.byteLength; i++) {
    result += String.fromCharCode(value.getUint8(i));
  }

  log('> ' + result);
}


function isWebBluetoothEnabled() {
  if (navigator.bluetooth) {
    return true;
  }
  else {
    log('Web Bluetooth API is not available.\n' +
      'Please make sure the Web Bluetooth flag is enabled.');
    return false;
  }
}


function str2ab(str) {
  var buf = new ArrayBuffer(str.length);
  var bufView = new Uint8Array(buf);
  for (var i=0, strLen=str.length; i<strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return buf;
}



document.querySelector('#connect').addEventListener('click', function(event) {
  event.stopPropagation();
  event.preventDefault();

  if (isWebBluetoothEnabled()) {
    Logger.clearLog();
    onStartButtonClick();
  }
});

document.querySelector('#disconnect').addEventListener('click', function(event) {
  event.stopPropagation();
  event.preventDefault();

  if (isWebBluetoothEnabled()) {
    onStopButtonClick();
  }
});

document.querySelector('#send').addEventListener('click', function(event) {
  event.stopPropagation();
  event.preventDefault();

  if (isWebBluetoothEnabled()) {
    onSendButtonClick();
  }
});
</script>

</body>
</html>
